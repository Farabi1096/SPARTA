<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARTA MTD Sales Performance Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom Gradient Fill for Header (VIBRANT GREEN-TO-PURPLE) */
        .header-gradient {
            /* Vibrant Green (#11998e) to Deep Violet (#6a0dad) - approx. 120deg */
            background: linear-gradient(120deg, #11998e 0%, #6a0dad 100%); 
        }

        .gauge-meter {
            height: 10px;
            border-radius: 9999px;
            overflow: hidden;
            background-color: #e5e7eb; /* Gray-200 */
        }
        .gauge-fill {
            transition: width 0.7s ease-out;
            border-radius: 9999px;
            height: 100%; 
        }
        /* RAG Colors for Gauge Fill & Background */
        .fill-green { background-color: #10b981; } /* Emerald-500 */
        .fill-amber { background-color: #f59e0b; } /* Amber-500 */
        .fill-red { background-color: #ef4444; } /* Red-500 */
        .fill-blue { background-color: #3b82f6; } /* Blue-500 for benchmark */
        
        /* RAG Colors for Rings/Text */
        .ring-green { --tw-ring-color: #10b981; }
        .ring-amber { --tw-ring-color: #f59e0b; }
        .ring-red { --tw-ring-color: #ef4444; }
        .ring-blue { --tw-ring-color: #3b82f6; }

        .text-green { color: #10b981; }
        .text-amber { color: #f59e0b; }
        .text-red { color: #ef4444; }
        .text-blue { color: #3b82f6; }
        /* Added specific colors for comparison text */
        .text-red-600 { color: #dc2626; } 
        .text-green-600 { color: #059669; }

        .text-gray-400 { color: #9ca3af; }

        .chart-bar {
            transition: width 0.7s ease-out;
            height: 100%;
            min-width: 1rem; /* Minimum width for visibility */
        }
        
        /* --- NEW TAB STYLES --- */
        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-lg */
            font-weight: 500;
            font-size: 0.875rem; /* text-sm */
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .tab-active {
            background-color: white;
            color: #11998e; /* Match header green */
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .tab-inactive {
            background-color: transparent;
            color: #f4f7f9; /* Light text */
            opacity: 0.8;
        }
        .tab-inactive:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-7xl mx-auto">

        <!-- Header: Title, Subtitle, and Filter Controls -->
        <header class="header-gradient p-6 rounded-xl shadow-xl mb-8 flex flex-col xl:flex-row justify-between items-start xl:items-center border border-gray-200">
            <div class="mb-4 xl:mb-0">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-white">SPARTA MTD Sales Performance</h1>
                <!-- UPDATED DATE -->
                <p class="text-lg text-gray-200 mt-1">(Data as of Nov 17th, 2025)</p>
            </div>
            
            <!-- Filter Dropdowns Section (Compact layout) -->
            <div id="filter-controls" class="flex flex-wrap gap-2 p-2 header-gradient rounded-lg shadow-lg border border-gray-400">
                <!-- Dropdowns will be dynamically inserted here by JavaScript -->
            </div>
        </header>

        <!-- KPI Cards Section (5 Cards) -->
        <div id="kpi-cards" class="grid grid-cols-2 md:grid-cols-5 gap-6 md:gap-8 mb-6">
            <!-- Cards will be dynamically inserted here -->
        </div>

        <!-- NEW TAB CONTROLS (MOVED HERE) -->
        <div class="flex justify-center mb-6 z-10 relative">
            <div class="flex p-1 bg-gray-700/30 rounded-lg shadow-md backdrop-blur-sm">
                <button id="tab-territory" class="tab-button tab-active">
                    Territory Update
                </button>
                <button id="tab-db" class="tab-button tab-inactive">
                    DB Update
                </button>
                <button id="tab-sr" class="tab-button tab-inactive">
                    DFF Update
                </button>
            </div>
        </div>

        <!-- Section 2: Visuals (Toggled Panels) -->
        
        <!-- Visuals Panel 1: Main (DB/SR Health & Territory/DB Chart) -->
        <div id="visuals-panel-main" style="display: grid;" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">

            <!-- Performance Status (DB & SR) -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Performance Status (DB & SR)</h2>
                <p class="text-sm text-gray-500 mb-4">No. of performers Above 90%, 85-90%, and Below 85% of Time elapsed %.</p>
                
                <!-- SR Status: This will be dynamically updated by updateSrStatus() -->
                <div id="sr-health" class="mb-4">
                    <h3 class="text-md font-semibold text-gray-700 mb-2">SR Status (Total: 0)</h3>
                    <div class="flex h-6 rounded-full overflow-hidden text-xs font-semibold">
                        <div class="chart-bar fill-green text-center text-white p-1" style="width: 0%;">0</div>
                        <div class="chart-bar fill-amber text-center text-white p-1" style="width: 0%; min-width: 1.5rem;">0</div> 
                        <div class="chart-bar fill-red text-center text-white p-1" style="width: 0%;">0</div>
                    </div>
                    <div class="flex justify-between text-xs mt-1">
                        <span class="text-green">Above 90%: 0</span>
                        <span class="text-amber">85-90%: 0</span>
                        <span class="text-red">Below 85%: 0</span>
                    </div>
                </div>

                <!-- DB Status: This will be dynamically updated by updateDbStatus() -->
                <div id="db-health">
                    <h3 class="text-md font-semibold text-gray-700 mb-2">DB Status (Total: 0)</h3>
                    <div class="flex h-6 rounded-full overflow-hidden text-xs font-semibold">
                        <div class="chart-bar fill-green text-center text-white p-1" style="width: 0%;">0</div>
                        <div class="chart-bar fill-amber text-center text-white p-1" style="width: 0%; min-width: 1.5rem;">0</div> 
                        <div class="chart-bar fill-red text-center text-white p-1" style="width: 0%;">0</div>
                    </div>
                    <div class="flex justify-between text-xs mt-1">
                        <span class="text-green">Above 90%: 0</span>
                        <span class="text-amber">85-90%: 0</span>
                        <span class="text-red">Below 85%: 0</span>
                    </div>
                </div>
            </div>

            <!-- Chart Section (Toggles between Territory and DB) -->
            <div class="lg:col-span-2">
                <!-- Territory STT Achievement Chart (Visible by default) -->
                <div id="territory-chart-container" style="display: block;" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Territory STT Achievement vs. Target</h2>
                    <p class="text-sm font-semibold text-gray-500 mb-4">Time Elapsed Target: <span class="text-blue">53.85%</span> (Ranked by Achievement)</p>
                    <div id="stt-chart" class="space-y-4">
                        <!-- Chart bars populated by JS -->
                    </div>
                </div>

                <!-- DB STT Achievement Chart (Hidden by default) -->
                <div id="db-chart-container" style="display: none;" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">DB STT Achievement vs. Target</h2>
                    <p class="text-sm font-semibold text-gray-500 mb-4">Time Elapsed Target: <span class="text-blue">53.85%</span> (Ranked by Achievement)</p>
                    <div id="db-stt-chart" class="space-y-4">
                        <!-- Chart bars populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Visuals Panel 2: SR View (Top/Bottom 10) -->
        <div id="visuals-panel-sr" style="display: none;" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
            
            <!-- Top 10 SR Chart -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Top 10 SR Nationally (by STT Ach %)</h2>
                <p class="text-sm font-semibold text-gray-500 mb-4">Time Elapsed Target: <span class="text-blue">53.85%</span></p>
                <div id="top-10-sr-chart" class="space-y-4">
                    <!-- Top 10 SRs populated by JS -->
                </div>
            </div>
            
            <!-- Bottom 10 SR Chart -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Bottom 10 SR (by STT Ach %)</h2>
                <p class="text-sm font-semibold text-gray-500 mb-4">Time Elapsed Target: <span class="text-blue">53.85%</span></p>
                <div id="bottom-10-sr-chart" class="space-y-4">
                    <!-- Bottom 10 SRs populated by JS -->
                </div>
            </div>
            
        </div>

        <!-- TAB PANELS WRAPPER -->
        <div id="tab-panels">

            <!-- Panel 1: Territory (Visible by default) -->
            <div id="panel-territory" style="display: block;">
                <!-- Section 3: Detailed Territory Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-10">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Detailed Territory Performance MTD</h2>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Territory</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">STT TGT (Lac)</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">STT Ach (Lac)</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">STT Ach %</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ERC TGT</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ERC Ach</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ERC Ach %</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SF TBR TGT</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SF TBR Ach</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SF TBR Ach %</th>
                                    <th scope="col" scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P.SKU TGT</th>
                                    <th scope="col" scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P.SKU Ach</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P.SKU Ach %</th>
                                </tr>
                            </thead>
                            <tbody id="territory-list" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be populated here by JavaScript -->
                            </tbody>
                            <!-- Grand Total Row will be appended here by JS -->
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Panel 2: DB (Hidden by default) -->
            <div id="panel-db" style="display: none;">
                <!-- Section 4: Detailed DB Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Detailed DB Performance MTD</h2>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DB Name</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">STT TGT (Lac)</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">STT Ach (Lac)</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">STT Ach %</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ERC TGT</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ERC Ach</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ERC Ach %</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SF TBR TGT</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SF TBR Ach</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SF TBR Ach %</th>
                                    <th scope="col" scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P.SKU TGT</th>
                                    <th scope="col" scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P.SKU Ach</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P.SKU Ach %</th>
                                </tr>
                            </thead>
                            <tbody id="db-list" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be populated here by JavaScript -->
                            </tbody>
                            <!-- Grand Total Row will be appended here by JS -->
                        </table>
                    </div>
                </div>
            </div>

            <!-- Panel 3: SR (Hidden by default) -->
            <div id="panel-sr" style="display: none;">
                <!-- Section 5: Detailed SR Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Detailed SR Performance MTD</h2>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DFF Name</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">STT TGT (Lac)</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">STT Ach (Lac)</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">STT Ach %</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ERC TGT</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ERC Ach</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ERC Ach %</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SF TBR Ach</th>
                                    <th scope="col" scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P.SKU TGT</th>
                                    <th scope="col" scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P.SKU Ach</th>
                                    <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P.SKU Ach %</th>
                                </tr>
                            </thead>
                            <tbody id="sr-list" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be populated here by JavaScript -->
                            </tbody>
                            <!-- Grand Total Row will be appended here by JS -->
                        </table>
                    </div>
                </div>
            </div>
        </div> <!-- End of Tab Panels Wrapper -->
    </div>

    <script>
        // --- (FIXED) ALL FUNCTIONS DEFINED *BEFORE* THEY ARE CALLED ---

        // --- GLOBAL DATA & BENCHMARKS ---
        const timeElapsedPercent = 53.85; // UPDATED: Benchmark set to Nov 17th (14/26 days)
        const LAC_DIVISOR = 100000;
        
        // Object to track current selections
        let selectedFilters = {
            'Area': 'All Areas',
            'Territory': 'All Territories',
            'DB Name': 'All DBs'
        };
        
        let activeTab = 'territory'; // To track current tab state
        
        // Global references to filter <select> elements
        let areaSelect, territorySelect, dbNameSelect;
        
        // --- HELPER FUNCTIONS (DEFINED FIRST) ---

        /**
         * Parses a string value that might contain commas (like "1,000,000") into a clean number.
         * If the value is already a number, it returns it directly.
         * If the value is invalid, it returns 0.
         */
        function parseNumeric(value) {
            if (typeof value === 'number') {
                return value;
            }
            if (typeof value === 'string') {
                // Remove commas, percentage signs, and then convert to float
                const cleanedValue = value.replace(/,/g, '').replace(/%/g, '');
                const number = parseFloat(cleanedValue);
                return isNaN(number) ? 0 : number;
            }
            return 0;
        }

        /**
         * (NEW) Populates a <select> element with options, preserving selection if possible.
         */
        function populateSelectWithOptions(selectElement, optionsArray, currentFilterKey) {
            const currentSelectedValue = selectedFilters[currentFilterKey];
            selectElement.innerHTML = ''; // Clear existing options

            optionsArray.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });

            // Try to preserve selection if it's still in the new valid list
            if (optionsArray.includes(currentSelectedValue)) {
                selectElement.value = currentSelectedValue;
            } else {
                // If old selection is invalid (e.g., filtered out), default to 'All'
                selectElement.value = optionsArray[0]; // e.g., 'All Territories'
                // And update the global state object
                selectedFilters[currentFilterKey] = selectElement.value;
            }
        }

        /**
         * (NEW) Updates dependent filter dropdowns based on parent selection.
         */
        function updateDependentFilters(changedFilterName) {
            // 1. Get currently possible values based on filters
            let availableSrs = [...fullSrData];

            // Filter by Area (if selected)
            if (selectedFilters.Area !== 'All Areas') {
                availableSrs = availableSrs.filter(sr => sr.area === selectedFilters.Area);
            }

            // Get available territories from the *area-filtered* SR list
            const availableTerritories = ['All Territories', ...new Set(availableSrs.map(item => item.territory).sort())];
            
            // If the changed filter was Area, update Territory dropdown AND reset it
            if (changedFilterName === 'Area') {
                populateSelectWithOptions(territorySelect, availableTerritories, 'Territory');
                selectedFilters.Territory = 'All Territories'; // Reset territory
            }

            // Filter by Territory (if selected)
            if (selectedFilters.Territory !== 'All Territories') {
                availableSrs = availableSrs.filter(sr => sr.territory === selectedFilters.Territory);
            }

            // Get available DBs from the *area- and territory-filtered* SR list
            const availableDbNames = ['All DBs', ...new Set(availableSrs.map(item => item.dhName).sort())];

            // If changed filter was Area or Territory, update DB dropdown AND reset it
            if (changedFilterName === 'Area' || changedFilterName === 'Territory') {
                populateSelectWithOptions(dbNameSelect, availableDbNames, 'DB Name');
                selectedFilters['DB Name'] = 'All DBs'; // Reset DB
            }
        }

        /**
         * (NEW) Helper function to create a single filter dropdown.
         */
        function createFilterDropdown(filterName, options) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex flex-col text-sm';

            const label = document.createElement('label');
            label.textContent = filterName;
            const filterId = `filter-${filterName.replace(/\s/g, '')}`;
            label.htmlFor = filterId;
            label.className = 'text-xs font-semibold text-gray-200 mb-1 pl-1'; 
            
            const select = document.createElement('select');
            select.id = filterId;
            select.className = 'py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-700 bg-white cursor-pointer transition-all duration-150';
            
            // Populate options
            populateSelectWithOptions(select, options, filterName);

            // Attach event listener to update selection and re-apply filters
            select.addEventListener('change', (event) => {
                const selectedValue = event.target.value;
                selectedFilters[filterName] = selectedValue;
                
                // Update dependent filters (e.g., Area change updates Territory and DB)
                updateDependentFilters(filterName);
                
                applyFilters(); // Trigger filtering and re-rendering
            });
            
            wrapper.appendChild(label);
            wrapper.appendChild(select);

            return { wrapper, select };
        }

        /**
         * Calculates all achievement percentages for a given data object (Territory, DB, or SR).
         * This ensures data is consistent and calculations are centralized.
         */
        function calculatePercentages(data) {
            data.sttAchPercent = (data.sttTgt > 0) ? (data.sttAch / data.sttTgt) * 100 : 0;
            data.ercAchPercent = (data.ercTgt > 0) ? (data.ercAch / data.ercTgt) * 100 : 0;
            data.sfTbrAchPercent = (data.sfTbrTgt > 0) ? (data.sfTbrAch / data.sfTbrTgt) * 100 : 0;
            data.premiumSkuAchPercent = (data.premiumSkuGoal > 0) ? (data.premiumSkuAch / data.premiumSkuGoal) * 100 : 0;
            return data;
        }

        function getRAGStatus(percentage) {
            // 90% of Time Elapsed = 53.85% * 0.9 = 48.465%
            const benchmarkHigh = timeElapsedPercent * 0.90;
            // 85% of Time Elapsed = 53.85% * 0.85 = 45.77%
            const benchmarkLow = timeElapsedPercent * 0.85;

            // Updated RAG logic:
            // Green: >= 90% of Time Elapsed (>= 48.465%)
            // Amber: 85% - 90% of Time Elapsed (45.77% - 48.464%)
            // Red: < 85% of Time Elapsed (< 45.77%)
            
            if (percentage >= benchmarkHigh) { // >= 48.465%
                return { color: 'fill-green', text: 'Green', ring: 'ring-green', textColor: 'text-green' };
            } else if (percentage >= benchmarkLow) { // >= 45.77%
                return { color: 'fill-amber', text: 'Amber', ring: 'ring-amber', textColor: 'text-amber' };
            } else { // < 45.77%
                return { color: 'fill-red', text: 'Red', ring: 'ring-red', textColor: 'text-red' };
            }
        }

        function formatInLac(amount) {
            return (amount / LAC_DIVISOR).toFixed(2);
        }

        function formatCount(amount) {
            // Round to nearest whole number for counts
            const roundedAmount = Math.round(amount);
            return roundedAmount.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }
        
        function formatValue(value, unit) {
            if (unit === "Lac") { 
                return (value / LAC_DIVISOR).toFixed(2);
            }
            // All other units are counts
            return formatCount(value);
        }

        function calculateGrandTotals(dataArray) {
            const totals = {
                sttTgt: 0, sttAch: 0, ercTgt: 0, ercAch: 0, 
                sfTbrTgt: 0, sfTbrAch: 0, premiumSkuGoal: 0, premiumSkuAch: 0
            };

            dataArray.forEach(data => {
                for (const key in totals) {
                    if (data[key] && typeof data[key] === 'number') {
                        totals[key] += data[key];
                    }
                }
            });

            // Calculate percentages dynamically based on the filtered totals
            totals.sttAchPercent = (totals.sttTgt > 0) ? (totals.sttAch / totals.sttTgt) * 100 : 0;
            totals.ercAchPercent = (totals.ercTgt > 0) ? (totals.ercAch / totals.ercTgt) * 100 : 0;
            totals.sfTbrAchPercent = (totals.sfTbrTgt > 0) ? (totals.sfTbrAch / totals.sfTbrTgt) * 100 : 0;
            totals.premiumSkuAchPercent = (totals.premiumSkuGoal > 0) ? (totals.premiumSkuAch / totals.premiumSkuGoal) * 100 : 0;
            
            return totals;
        }
        
        function updateKpiData(totals) {
            // Check if filtering is active (i.e., totals are derived from a subset of data)
            const isFiltered = selectedFilters.Area !== 'All Areas' || selectedFilters.Territory !== 'All Territories' || selectedFilters['DB Name'] !== 'All DBs';

            let kpiTotalSTT, kpiTotalERC, kpiTotalTBRTgt, kpiTotalTBRAch, kpiTotalPSKUTGT, kpiTotalPSKUACH, kpiTotalPSKUACHPercent;

            // ALWAYS use the calculated totals from the (potentially filtered) dataArray.
            kpiTotalSTT = totals.sttAchPercent;
            kpiTotalERC = totals.ercAchPercent;
            kpiTotalTBRTgt = totals.sfTbrTgt;
            kpiTotalTBRAch = totals.sfTbrAch; // For TBR, the main KPI card shows the count
            kpiTotalPSKUTGT = totals.premiumSkuGoal;
            kpiTotalPSKUACH = totals.premiumSkuAch;
            kpiTotalPSKUACHPercent = totals.premiumSkuAchPercent;
            
            const newKpiData = {
                timeElapsed: {
                    label: "Time Elapsed", 
                    percentage: timeElapsedPercent,
                    valueText: "14 out of 26 Working Days Passed", // UPDATED
                    rag: { color: 'fill-blue', border: 'border-blue', text: 'Benchmark', textColor: 'text-blue', ring: 'ring-blue' },
                    isBenchmark: true
                },
                mtdStt: {
                    label: "MTD STT Ach", 
                    percentage: kpiTotalSTT, 
                    unit: "Lac",
                    target: totals.sttTgt, 
                    achieved: totals.sttAch, 
                    rag: null, 
                    actualValue: kpiTotalSTT.toFixed(2) + "%"
                },
                mtdErc: {
                    label: "MTD ERC Ach", 
                    percentage: kpiTotalERC,
                    unit: "Stores",
                    target: totals.ercTgt, 
                    achieved: totals.ercAch, 
                    rag: null, 
                    actualValue: kpiTotalERC.toFixed(2) + "%"
                },
                sfTbr: {
                    label: "SF TBR Vol.", // <-- UPDATED LABEL
                    percentage: (kpiTotalTBRTgt > 0) ? (kpiTotalTBRAch / kpiTotalTBRTgt) * 100 : 0, 
                    unit: "TBRs",
                    target: kpiTotalTBRTgt, 
                    achieved: kpiTotalTBRAch, 
                    rag: null,
                    actualValue: formatCount(kpiTotalTBRAch) 
                },
                premiumTp: {
                    label: "Premium TP Ach", 
                    percentage: kpiTotalPSKUACHPercent,
                    unit: "Stores",
                    target: kpiTotalPSKUTGT, 
                    achieved: kpiTotalPSKUACH, 
                    rag: null, 
                    actualValue: kpiTotalPSKUACHPercent.toFixed(2) + "%"
                }
            };
            // RAG calculation must be based on the percentage KPI, not the unit (e.g., STT %)
            newKpiData.mtdStt.rag = getRAGStatus(newKpiData.mtdStt.percentage);
            newKpiData.mtdErc.rag = getRAGStatus(newKpiData.mtdErc.percentage);
            newKpiData.sfTbr.rag = getRAGStatus(newKpiData.sfTbr.percentage);
            newKpiData.premiumTp.rag = getRAGStatus(newKpiData.premiumTp.percentage);
            
            return newKpiData;
        }

        function createKpiCard(kpi) {
            const rag = kpi.rag || getRAGStatus(kpi.percentage);
            
            let mainValue = kpi.actualValue;
            let subContent = `<p class="text-sm text-gray-500 mt-2 font-medium">${kpi.valueText}</p>`;
            let mainValueClass = rag.textColor;
            let comparisonText = ''; 

            if (!kpi.isBenchmark) {
                const target = kpi.target;
                const achieved = kpi.achieved;
                const balance = target - achieved;
                const unit = kpi.unit;

                const fmtTarget = formatValue(target, unit);
                const fmtAchieved = formatValue(achieved, unit);
                const fmtBalance = formatValue(balance, unit);
                
                if (kpi.label.includes('MTD STT Ach') || kpi.label.includes('MTD ERC Ach') || kpi.label.includes('Premium TP Ach')) {
                    const difference = kpi.percentage - timeElapsedPercent;
                    let diffValue;
                    let diffClass = difference < 0 ? 'text-red-600' : 'text-green-600';
                    
                    if (difference < 0) {
                        diffValue = `-${Math.abs(difference).toFixed(2)}%`;
                    } else {
                        diffValue = `+${difference.toFixed(2)}%`;
                    }

                    comparisonText = `
                        <div class="flex justify-between items-center text-gray-600">
                            <span class="text-xs font-medium">vs. Time Elapsed (${timeElapsedPercent.toFixed(2)}%):</span>
                            <span class="font-bold text-sm ${diffClass}">${diffValue}</span>
                        </div>
                    `;

                    mainValue = kpi.percentage.toFixed(2) + '%'; 
                    mainValueClass = rag.textColor; 
                    
                } else if (kpi.label.includes('SF TBR Vol.')) { // <-- UPDATED LABEL CHECK
                    mainValue = formatCount(achieved);
                    mainValueClass = rag.textColor;
                } else {
                    mainValue = kpi.percentage.toFixed(2) + '%';
                    mainValueClass = rag.textColor;
                }

                const displayUnit = unit === "Lac" ? "Lac" : "";

                // --- UPDATED to hide TGT and Balance for SF TBR Vol. ---
                let baseContent = ''; 

                if (kpi.label.includes('SF TBR Vol.')) {
                    // Special content for SF TBR Vol. (Only Achieved)
                    baseContent = `
                        <!-- Achieved -->
                        <div class="flex justify-between items-center text-gray-600">
                            <span class="text-xs font-medium">Achieved:</span>
                            <span class="font-bold text-sm ${rag.textColor}">${fmtAchieved}</span>
                        </div>
                    `;
                } else {
                    // Original content for all other cards
                    baseContent = `
                        <!-- Target -->
                        <div class="flex justify-between items-center text-gray-600">
                            <span class="text-xs font-medium">TGT (${displayUnit}):</span>
                            <span class="font-bold text-sm text-gray-700">${fmtTarget}</span>
                        </div>
                        <!-- Achieved -->
                        <div class="flex justify-between items-center text-gray-600">
                            <span class="text-xs font-medium">Achieved:</span>
                            <span class="font-bold text-sm ${rag.textColor}">${fmtAchieved}</span>
                        </div>
                        <!-- Balance -->
                        <div class="flex justify-between items-center text-gray-600">
                            <span class="text-xs font-medium">Balance:</span>
                            <span class="font-bold text-sm ${balance >= 0 ? 'text-gray-400' : 'text-red-500'}">${fmtBalance}</span>
                        </div>
                    `;
                }
                // --- END OF UPDATE ---
                
                if (comparisonText) {
                    subContent = `
                        <div class="mt-3 pt-3 border-t border-gray-100 space-y-1 text-sm">
                            ${comparisonText}
                            <div class="space-y-1 pt-1 border-t border-gray-100">
                                ${baseContent}
                            </div>
                        </div>
                    `;
                } else {
                    subContent = `
                        <div class="mt-3 pt-3 border-t border-gray-100 space-y-1 text-sm">
                            ${baseContent}
                        </div>
                    `;
                }
                
            } else {
                mainValue = kpi.percentage.toFixed(2) + '%';
                mainValueClass = 'text-blue';
            }
            
            // --- CARD HTML STRUCTURE ---
            const cardHtml = `
                <div class="bg-white p-6 rounded-xl shadow-xl transition hover:shadow-2xl border border-gray-100 ${kpi.isBenchmark ? 'col-span-2 md:col-span-1' : ''}">
                    
                    <!-- KPI Label and RAG Indicator Dot/Pill -->
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-medium text-gray-500">${kpi.label}</p>
                        <span class="w-3 h-3 rounded-full ${rag.color.replace('fill-', 'bg-')} ring-2 ring-offset-2 ${rag.ring}"></span>
                    </div>

                    <!-- Main Achievement Metric (Percentage or Count) -->
                    <div class="text-3xl md:text-4xl font-extrabold mt-1 ${mainValueClass}">${mainValue}</div>
                    
                    <!-- Gauge Meter -->
                    <div class="gauge-meter mt-4 mb-3">
                        <div class="gauge-fill ${rag.color}" style="width: ${Math.min(100, kpi.percentage).toFixed(2)}%"></div>
                    </div>
                    
                    <!-- Sub Content (TGT/ACH/BAL or Benchmark Text) -->
                    ${subContent}
                </div>
            `;
            return cardHtml;
        }


        function populateKpiCards(kpiData) {
            const container = document.getElementById('kpi-cards');
            container.innerHTML = '';
            const orderedKeys = ['timeElapsed', 'mtdStt', 'mtdErc', 'sfTbr', 'premiumTp'];
            orderedKeys.forEach(key => {
                const kpi = kpiData[key];
                if (kpi) {
                    container.insertAdjacentHTML('beforeend', createKpiCard(kpi));
                }
            });
        }
        
        // Generic function to populate a table
        function populateTable(tableId, dataArray, keyForName, keyForSubtext, isSrTable = false) {
            const tableBody = document.getElementById(tableId);
            const table = tableBody.closest('table');
            
            let tfoot = table.querySelector('tfoot');
            if (tfoot) tfoot.remove();

            tableBody.innerHTML = ''; 

            if (dataArray.length === 0) {
                const colspan = isSrTable ? "11" : "13";
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-8 text-gray-500 font-semibold text-lg">No data found for the selected filters.</td></tr>`;
                return;
            }

            dataArray
                .sort((a, b) => b.sttAchPercent - a.sttAchPercent) 
                .forEach(data => {
                // Auto-calculate percentages for every row
                data = calculatePercentages(data);
                            
                const sttRag = getRAGStatus(data.sttAchPercent);
                const ercRag = getRAGStatus(data.ercAchPercent);
                const tbrRag = getRAGStatus(data.sfTbrAchPercent);
                const pskuRag = getRAGStatus(data.premiumSkuAchPercent);

                const getAchClass = (percentage) => getRAGStatus(percentage).textColor;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                
                // SR table has fewer columns
                if (isSrTable) {
                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white shadow-sm z-10">
                            ${data[keyForName]}
                            <div class="text-xs text-gray-500">${data[keyForSubtext] || ''}</div>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-500">${formatInLac(data.sttTgt)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-medium ${sttRag.textColor}">${formatInLac(data.sttAch)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-bold ${getAchClass(data.sttAchPercent)}">${data.sttAchPercent.toFixed(2)}%</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-500">${formatCount(data.ercTgt)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-medium ${ercRag.textColor}">${formatCount(data.ercAch)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-bold ${getAchClass(data.ercAchPercent)}">${data.ercAchPercent.toFixed(2)}%</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-medium ${tbrRag.textColor}">${formatCount(data.sfTbrAch)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-500">${formatCount(data.premiumSkuGoal)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-medium ${pskuRag.textColor}">${formatCount(data.premiumSkuAch)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-bold ${getAchClass(data.premiumSkuAchPercent)}">${data.premiumSkuAchPercent.toFixed(2)}%</td>
                    `;
                } else {
                    // Territory and DB tables
                    row.innerHTML = `
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white shadow-sm z-10">
                            ${data[keyForName]}
                            <div class="text-xs text-gray-500">${data[keyForSubtext] || ''}</div>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-500">${formatInLac(data.sttTgt)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-medium ${sttRag.textColor}">${formatInLac(data.sttAch)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-bold ${getAchClass(data.sttAchPercent)}">${data.sttAchPercent.toFixed(2)}%</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-500">${formatCount(data.ercTgt)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-medium ${ercRag.textColor}">${formatCount(data.ercAch)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-bold ${getAchClass(data.ercAchPercent)}">${data.ercAchPercent.toFixed(2)}%</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-500">${formatCount(data.sfTbrTgt)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-medium ${tbrRag.textColor}">${formatCount(data.sfTbrAch)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-bold ${getAchClass(data.sfTbrAchPercent)}">${data.sfTbrAchPercent.toFixed(2)}%</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-500">${formatCount(data.premiumSkuGoal)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-medium ${pskuRag.textColor}">${formatCount(data.premiumSkuAch)}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-bold ${getAchClass(data.premiumSkuAchPercent)}">${data.premiumSkuAchPercent.toFixed(2)}%</td>
                    `;
                }
                tableBody.appendChild(row);
            });
            
            // --- APPEND GRAND TOTALS ---
            const grandTotals = calculateGrandTotals(dataArray);
            tfoot = document.createElement('tfoot');
            tfoot.className = 'bg-gray-100 border-t-2 border-gray-300';
            
            const totalRow = document.createElement('tr');
            
            const getAchClassForTotal = (percentage) => getRAGStatus(percentage).textColor;
            
            if (isSrTable) {
                totalRow.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-extrabold text-gray-900 sticky left-0 bg-gray-100 shadow-sm z-10">
                        GRAND TOTAL (${dataArray.length} items)
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-bold text-gray-700">${formatInLac(grandTotals.sttTgt)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold text-gray-900">${formatInLac(grandTotals.sttAch)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold ${getAchClassForTotal(grandTotals.sttAchPercent)}">${grandTotals.sttAchPercent.toFixed(2)}%</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-700">${formatCount(grandTotals.ercTgt)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold text-gray-900">${formatCount(grandTotals.ercAch)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold ${getAchClassForTotal(grandTotals.ercAchPercent)}">${grandTotals.ercAchPercent.toFixed(2)}%</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold text-gray-900">${formatCount(grandTotals.sfTbrAch)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-700">${formatCount(grandTotals.premiumSkuGoal)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold text-gray-900">${formatCount(grandTotals.premiumSkuAch)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold ${getAchClassForTotal(grandTotals.premiumSkuAchPercent)}">${grandTotals.premiumSkuAchPercent.toFixed(2)}%</td>
                `;
            } else {
                 totalRow.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-extrabold text-gray-900 sticky left-0 bg-gray-100 shadow-sm z-10">
                        GRAND TOTAL (${dataArray.length} items)
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-bold text-gray-700">${formatInLac(grandTotals.sttTgt)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold text-gray-900">${formatInLac(grandTotals.sttAch)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold ${getAchClassForTotal(grandTotals.sttAchPercent)}">${grandTotals.sttAchPercent.toFixed(2)}%</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-700">${formatCount(grandTotals.ercTgt)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold text-gray-900">${formatCount(grandTotals.ercAch)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold ${getAchClassForTotal(grandTotals.ercAchPercent)}">${grandTotals.ercAchPercent.toFixed(2)}%</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-700">${formatCount(grandTotals.sfTbrTgt)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold text-gray-900">${formatCount(grandTotals.sfTbrAch)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold ${getAchClassForTotal(grandTotals.sfTbrAchPercent)}">${grandTotals.sfTbrAchPercent.toFixed(2)}%</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-700">${formatCount(grandTotals.premiumSkuGoal)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold text-gray-900">${formatCount(grandTotals.premiumSkuAch)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-center font-extrabold ${getAchClassForTotal(grandTotals.premiumSkuAchPercent)}">${grandTotals.premiumSkuAchPercent.toFixed(2)}%</td>
                `;
            }
            
            tfoot.appendChild(totalRow);
            table.appendChild(tfoot);
        }

        function populateTerritoryChart(dataArray) {
            const chartContainer = document.getElementById('stt-chart');
            chartContainer.innerHTML = '';
            
            // Update time elapsed text
            const timeElapsedText = document.querySelector('#territory-chart-container .text-sm');
            if(timeElapsedText) timeElapsedText.innerHTML = `Time Elapsed Target: <span class="text-blue">${timeElapsedPercent.toFixed(2)}%</span> (Ranked by Achievement)`;


            if (dataArray.length === 0) {
                chartContainer.innerHTML = `<div class="text-center py-8 text-gray-500 font-semibold">No chart data available for selection.</div>`;
                return;
            }

            dataArray
                .sort((a, b) => b.sttAchPercent - a.sttAchPercent)
                .forEach((data, index) => {
                const rank = index + 1; 
                data = calculatePercentages(data); // Ensure % is calculated
                const achievement = data.sttAchPercent;
                const status = getRAGStatus(achievement);
                const barWidth = Math.min(100, achievement).toFixed(2); 

                const gapPercent = achievement - timeElapsedPercent;
                const formattedGap = `${gapPercent > 0 ? '+' : ''}${gapPercent.toFixed(2)}%`;
                const gapColorClass = gapPercent >= 0 ? 'text-green-600' : 'text-red-600';

                const chartItem = document.createElement('div');
                chartItem.className = 'flex items-center';
                chartItem.innerHTML = `
                    <!-- Territory and TM Label -->
                    <div class="w-1/4 text-sm font-medium text-gray-700 truncate mr-4">
                        <div class="font-bold text-gray-900 truncate">#${rank} ${data.territory}</div>
                        <div class="text-xs text-gray-500 truncate">${data.tm}</div>
                    </div>
                    <!-- Bar and Gap -->
                    <div class="w-3/4 bg-gray-200 rounded-full h-8 flex items-center relative">
                        <div class="absolute h-full w-[2px] bg-blue-500 border-dashed border-l border-blue-700" style="left: ${timeElapsedPercent.toFixed(2)}%;"></div>
                        <div class="chart-bar h-full rounded-full flex items-center justify-end pr-2 text-white font-bold text-xs ${status.color}" style="width: ${barWidth}%;">
                            ${achievement > 10 ? achievement.toFixed(1) + '%' : ''}
                        </div>
                        <span class="absolute right-2 text-xs font-bold ${gapColorClass}">
                            GAP: ${formattedGap}
                        </span>
                        <!-- Show percentage outside if bar is too small -->
                        ${achievement <= 10 ? `<span class="absolute text-xs font-bold ${status.textColor}" style="left: calc(${barWidth}% + 5px);">${achievement.toFixed(1)}%</span>` : ''}
                    </div>
                `;
                chartContainer.appendChild(chartItem);
            });
        }

        function populateDbChart(dataArray) {
            const chartContainer = document.getElementById('db-stt-chart');
            chartContainer.innerHTML = '';
            
            // Update time elapsed text
            const timeElapsedText = document.querySelector('#db-chart-container .text-sm');
            if(timeElapsedText) timeElapsedText.innerHTML = `Time Elapsed Target: <span class="text-blue">${timeElapsedPercent.toFixed(2)}%</span> (Ranked by Achievement)`;


            if (dataArray.length === 0) {
                chartContainer.innerHTML = `<div class="text-center py-8 text-gray-500 font-semibold">No chart data available for selection.</div>`;
                return;
            }

            dataArray
                .sort((a, b) => b.sttAchPercent - a.sttAchPercent)
                .forEach((data, index) => {
                const rank = index + 1; 
                data = calculatePercentages(data); // Ensure % is calculated
                const achievement = data.sttAchPercent;
                const status = getRAGStatus(achievement);
                const barWidth = Math.min(100, achievement).toFixed(2); 

                const gapPercent = achievement - timeElapsedPercent;
                const formattedGap = `${gapPercent > 0 ? '+' : ''}${gapPercent.toFixed(2)}%`;
                const gapColorClass = gapPercent >= 0 ? 'text-green-600' : 'text-red-600';

                const chartItem = document.createElement('div');
                chartItem.className = 'flex items-center';
                chartItem.innerHTML = `
                    <!-- DB Name and Territory Label -->
                    <div class="w-1/4 text-sm font-medium text-gray-700 truncate mr-4">
                        <div class="font-bold text-gray-900 truncate">#${rank} ${data.dhName}</div>
                        <div class="text-xs text-gray-500 truncate">${data.territory}</div>
                    </div>
                    <!-- Bar and Gap -->
                    <div class="w-3/4 bg-gray-200 rounded-full h-8 flex items-center relative">
                        <div class="absolute h-full w-[2px] bg-blue-500 border-dashed border-l border-blue-700" style="left: ${timeElapsedPercent.toFixed(2)}%;"></div>
                        <div class="chart-bar h-full rounded-full flex items-center justify-end pr-2 text-white font-bold text-xs ${status.color}" style="width: ${barWidth}%;">
                            ${achievement > 10 ? achievement.toFixed(1) + '%' : ''}
                        </div>
                        <span class="absolute right-2 text-xs font-bold ${gapColorClass}">
                            GAP: ${formattedGap}
                        </span>
                        <!-- Show percentage outside if bar is too small -->
                         ${achievement <= 10 ? `<span class="absolute text-xs font-bold ${status.textColor}" style="left: calc(${barWidth}% + 5px);">${achievement.toFixed(1)}%</span>` : ''}
                    </div>
                `;
                chartContainer.appendChild(chartItem);
            });
        }
        
        function populateTopBottomSrCharts(dataArray) {
            const topContainer = document.getElementById('top-10-sr-chart');
            const bottomContainer = document.getElementById('bottom-10-sr-chart');
            const topContainerParent = topContainer.closest('.lg\\:col-span-1');
            const bottomContainerParent = bottomContainer.closest('.lg\\:col-span-1');
            const topTitle = topContainerParent.querySelector('h2');
            
            topContainer.innerHTML = '';
            bottomContainer.innerHTML = '';

            // Update time elapsed text (common for both)
            const topTimeElapsedText = topContainerParent.querySelector('.text-sm');
            if(topTimeElapsedText) topTimeElapsedText.innerHTML = `Time Elapsed Target: <span class="text-blue">${timeElapsedPercent.toFixed(2)}%</span>`;

            // Check if ANY filter is active
            const isFiltered = selectedFilters.Area !== 'All Areas' || 
                               selectedFilters.Territory !== 'All Territories' || 
                               selectedFilters['DB Name'] !== 'All DBs';

            if (dataArray.length === 0) {
                topContainer.innerHTML = `<div class="text-center py-8 text-gray-500 font-semibold">No data available for selection.</div>`;
                bottomContainerParent.style.display = 'none'; // Hide bottom if no data
                return;
            }
            
            // Calculate percentages for all SRs first (this is safe to re-run)
            dataArray.forEach(data => calculatePercentages(data));
            
            // Sort by STT Ach % (applies to both views)
            const sortedSrData = [...dataArray].sort((a, b) => b.sttAchPercent - a.sttAchPercent);

            if (isFiltered) {
                // --- FILTERED VIEW (Area, Territory, or DB) ---
                // 1. Hide Bottom 10 chart
                bottomContainerParent.style.display = 'none';
                
                // 2. Change Top 10 title
                topTitle.textContent = 'SR Performance (by STT Ach %)';
                
                // 3. Populate "Top" chart with ALL SRs for that filter, using their NATIONAL rank
                sortedSrData.forEach((data, index) => {
                    const rankText = `#${data.nationalRank}`; // Use pre-calculated national rank
                    const achievement = data.sttAchPercent;
                    const status = getRAGStatus(achievement);
                    const barWidth = Math.min(100, achievement).toFixed(2); 
                    const gapPercent = achievement - timeElapsedPercent;
                    const formattedGap = `${gapPercent > 0 ? '+' : ''}${gapPercent.toFixed(2)}%`;
                    const gapColorClass = gapPercent >= 0 ? 'text-green-600' : 'text-red-600';

                    const chartItem = document.createElement('div');
                    chartItem.className = 'flex items-center';
                    chartItem.innerHTML = `
                        <div class="w-1/4 text-sm font-medium text-gray-700 truncate mr-4">
                            <div class="font-bold text-gray-900 truncate">${rankText} ${data.dffName}</div>
                            <div class="text-xs text-gray-500 truncate">${data.dhName}</div>
                        </div>
                        <div class="w-3/4 bg-gray-200 rounded-full h-8 flex items-center relative">
                            <div class="absolute h-full w-[2px] bg-blue-500 border-dashed border-l border-blue-700" style="left: ${timeElapsedPercent.toFixed(2)}%;"></div>
                            <div class="chart-bar h-full rounded-full flex items-center justify-end pr-2 text-white font-bold text-xs ${status.color}" style="width: ${barWidth}%;">
                                ${achievement > 10 ? achievement.toFixed(1) + '%' : ''}
                            </div>
                            <span class="absolute right-2 text-xs font-bold ${gapColorClass}">
                                GAP: ${formattedGap}
                            </span>
                            <!-- Show percentage outside if bar is too small -->
                             ${achievement <= 10 ? `<span class="absolute text-xs font-bold ${status.textColor}" style="left: calc(${barWidth}% + 5px);">${achievement.toFixed(1)}%</span>` : ''}
                        </div>
                    `;
                    topContainer.appendChild(chartItem);
                });

            } else {
                // --- NATIONAL VIEW (DEFAULT - NO FILTERS) ---
                // 1. Show Bottom 10 chart
                bottomContainerParent.style.display = 'block';
                const bottomTimeElapsedText = bottomContainerParent.querySelector('.text-sm');
                if(bottomTimeElapsedText) bottomTimeElapsedText.innerHTML = `Time Elapsed Target: <span class="text-blue">${timeElapsedPercent.toFixed(2)}%</span>`;

                // 2. Set default titles
                topTitle.textContent = 'Top 10 SR Nationally (by STT Ach %)';
                
                // 3. Get Top 10 and Bottom 10
                const top10 = sortedSrData.slice(0, 10);
                const bottom10 = sortedSrData.slice(-10).reverse(); // Get last 10 and reverse
                const medals = ['', '', ''];

                // 4. Populate Top 10
                top10.forEach((data, index) => {
                    const achievement = data.sttAchPercent;
                    const status = getRAGStatus(achievement);
                    const barWidth = Math.min(100, achievement).toFixed(2); 
                    const gapPercent = achievement - timeElapsedPercent;
                    const formattedGap = `${gapPercent > 0 ? '+' : ''}${gapPercent.toFixed(2)}%`;
                    const gapColorClass = gapPercent >= 0 ? 'text-green-600' : 'text-red-600';
                    const medal = medals[index] || `<span>#${data.nationalRank}</span>`; // Use index for medal, but nationalRank for number

                    const chartItem = document.createElement('div');
                    chartItem.className = 'flex items-center';
                    chartItem.innerHTML = `
                        <div class="w-1/4 text-sm font-medium text-gray-700 truncate mr-4">
                            <div class="font-bold text-gray-900 truncate">${medal} ${data.dffName}</div>
                            <div class="text-xs text-gray-500 truncate">${data.dhName}</div>
                        </div>
                        <div class="w-3/4 bg-gray-200 rounded-full h-8 flex items-center relative">
                            <div class="absolute h-full w-[2px] bg-blue-500 border-dashed border-l border-blue-700" style="left: ${timeElapsedPercent.toFixed(2)}%;"></div>
                            <div class="chart-bar h-full rounded-full flex items-center justify-end pr-2 text-white font-bold text-xs ${status.color}" style="width: ${barWidth}%;">
                                ${achievement > 10 ? achievement.toFixed(1) + '%' : ''}
                            </div>
                            <span class="absolute right-2 text-xs font-bold ${gapColorClass}">
                                GAP: ${formattedGap}
                            </span>
                            <!-- Show percentage outside if bar is too small -->
                             ${achievement <= 10 ? `<span class="absolute text-xs font-bold ${status.textColor}" style="left: calc(${barWidth}% + 5px);">${achievement.toFixed(1)}%</span>` : ''}
                        </div>
                    `;
                    topContainer.appendChild(chartItem);
                });
                
                // 5. Populate Bottom 10
                bottom10.forEach((data, index) => {
                    const rank = data.nationalRank; // Use pre-calculated national rank
                    const achievement = data.sttAchPercent;
                    const status = getRAGStatus(achievement);
                    const barWidth = Math.max(0, Math.min(100, achievement)).toFixed(2);
                    const gapPercent = achievement - timeElapsedPercent;
                    const formattedGap = `${gapPercent > 0 ? '+' : ''}${gapPercent.toFixed(2)}%`;
                    const gapColorClass = gapPercent >= 0 ? 'text-green-600' : 'text-red-600';

                    const chartItem = document.createElement('div');
                    chartItem.className = 'flex items-center';
                    chartItem.innerHTML = `
                        <div class="w-1/4 text-sm font-medium text-gray-700 truncate mr-4">
                            <div class="font-bold text-gray-900 truncate">#${rank} ${data.dffName}</div>
                            <div class="text-xs text-gray-500 truncate">${data.dhName}</div>
                        </div>
                        <div class="w-3/4 bg-gray-200 rounded-full h-8 flex items-center relative">
                            <div class="absolute h-full w-[2px] bg-blue-500 border-dashed border-l border-blue-700" style="left: ${timeElapsedPercent.toFixed(2)}%;"></div>
                            <div class="chart-bar h-full rounded-full flex items-center justify-end pr-2 text-white font-bold text-xs ${status.color}" style="width: ${barWidth}%;">
                                 ${achievement > 10 ? achievement.toFixed(1) + '%' : ''}
                            </div>
                            <span class="absolute right-2 text-xs font-bold ${gapColorClass}">
                                GAP: ${formattedGap}
                            </span>
                            <!-- Show percentage outside if bar is too small -->
                             ${achievement <= 10 ? `<span class="absolute text-xs font-bold ${status.textColor}" style="left: calc(${barWidth}% + 5px);">${achievement.toFixed(1)}%</span>` : ''}
                        </div>
                    `;
                    bottomContainer.appendChild(chartItem);
                });
            }
        }


        function updateSrStatus(srDataArray) {
            const srHealthContainer = document.getElementById('sr-health');
            if (!srHealthContainer) return;

            let green = 0;
            let amber = 0;
            let red = 0;
            
            const total = srDataArray.length;

            // (FIX) Count the pre-defined status from the data, don't recalculate
            srDataArray.forEach(sr => {
                if (sr.performanceStatus === 'Above 90%') green++;
                else if (sr.performanceStatus === '85-90%') amber++;
                else red++; // Default to red if 'Below 85%' or undefined
            });

            const greenPct = total > 0 ? (green / total) * 100 : 0;
            const amberPct = total > 0 ? (amber / total) * 100 : 0;
            const redPct = total > 0 ? (red / total) * 100 : 0;

            srHealthContainer.innerHTML = `
                <h3 class="text-md font-semibold text-gray-700 mb-2">SR Status (Total: ${total})</h3>
                <div class="flex h-6 rounded-full overflow-hidden text-xs font-semibold">
                    <div class="chart-bar fill-green text-center text-white p-1" style="width: ${greenPct.toFixed(2)}%;">${green > 0 ? green : ''}</div>
                    <div class="chart-bar fill-amber text-center text-white p-1" style="width: ${amberPct.toFixed(2)}%; ${amberPct > 0 || amber == 0 ? 'min-width: 1.5rem;' : ''}">${amber}</div> 
                    <div class="chart-bar fill-red text-center text-white p-1" style="width: ${redPct.toFixed(2)}%;">${red > 0 ? red : ''}</div>
                </div>
                <div class="flex justify-between text-xs mt-1">
                    <span class="text-green">Above 90%: ${green}</span>
                    <span class="text-amber">85-90%: ${amber}</span>
                    <span class="text-red">Below 85%: ${red}</span>
                </div>
            `;
        }

        function updateDbStatus(dbDataArray) {
            const dbHealthContainer = document.getElementById('db-health');
            if (!dbHealthContainer) return;

            let green = 0;
            let amber = 0;
            let red = 0;
            
            // Recalculate percentages for DB array before counting
            dbDataArray.forEach(db => calculatePercentages(db));
            const total = dbDataArray.length;

            dbDataArray.forEach(db => {
                const status = getRAGStatus(db.sttAchPercent);
                if (status.text === 'Green') green++;
                else if (status.text === 'Amber') amber++;
                else red++;
            });

            const greenPct = total > 0 ? (green / total) * 100 : 0;
            const amberPct = total > 0 ? (amber / total) * 100 : 0;
            const redPct = total > 0 ? (red / total) * 100 : 0;

            dbHealthContainer.innerHTML = `
                <h3 class="text-md font-semibold text-gray-700 mb-2">DB Status (Total: ${total})</h3>
                <div class="flex h-6 rounded-full overflow-hidden text-xs font-semibold">
                    <div class="chart-bar fill-green text-center text-white p-1" style="width: ${greenPct.toFixed(2)}%;">${green > 0 ? green : ''}</div>
                    <div class="chart-bar fill-amber text-center text-white p-1" style="width: ${amberPct.toFixed(2)}%; ${amberPct > 0 || amber == 0 ? 'min-width: 1.5rem;' : ''}">${amber}</div> 
                    <div class="chart-bar fill-red text-center text-white p-1" style="width: ${redPct.toFixed(2)}%;">${red > 0 ? red : ''}</div>
                </div>
                <div class="flex justify-between text-xs mt-1">
                    <span class="text-green">Above 90%: ${green}</span>
                    <span class="text-amber">85-90%: ${amber}</span>
                    <span class="text-red">Below 85%: ${red}</span>
                </div>
            `;
        }
        
        // --- DATA PRE-PROCESSING & AGGREGATION (Run once on load) ---
        
        // (New arrays based on SR data)
        let processedTerritoryData = [];
        let processedDbData = [];
        
        // UPDATED: Replaced all data with the new dataset from Nov 17th
        // (FIX) Added performanceStatus field
        const rawSrData = [
            { area: "DHAKA", territory: "DHAKA WEST", tm: "NOOR MD. HABIBULLAH", lead: "JAYANTA BANIK", dhCode: "B004", dhName: "M/S Hasan Brothers Corporation", dffCode: "BDS0000025", dffName: "Emon", sttTgt: "550,000", sttAch: "222,717", performanceStatus: "Below 85%", ercTgt: "426", ercAch: "237", sfTbrTgt: "100", sfTbrAch: "3", premiumSkuGoal: "43", premiumSkuAch: "35" },
            { area: "DHAKA", territory: "DHAKA WEST", tm: "NOOR MD. HABIBULLAH", lead: "JAYANTA BANIK", dhCode: "B004", dhName: "M/S Hasan Brothers Corporation", dffCode: "BDS0000022", dffName: "Mehedi", sttTgt: "700,000", sttAch: "329,617", performanceStatus: "85-90%", ercTgt: "437", ercAch: "263", sfTbrTgt: "100", sfTbrAch: "6", premiumSkuGoal: "43", premiumSkuAch: "22" },
            { area: "DHAKA", territory: "DHAKA WEST", tm: "NOOR MD. HABIBULLAH", lead: "JAYANTA BANIK", dhCode: "B004", dhName: "M/S Hasan Brothers Corporation", dffCode: "BDS0000021", dffName: "Miraz", sttTgt: "4,270,000", sttAch: "321,133", performanceStatus: "Below 85%", ercTgt: "187", ercAch: "5", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "0", premiumSkuAch: "0" },
            { area: "DHAKA", territory: "DHAKA WEST", tm: "NOOR MD. HABIBULLAH", lead: "JAYANTA BANIK", dhCode: "B004", dhName: "M/S Hasan Brothers Corporation", dffCode: "BDS0000023", dffName: "Rubel", sttTgt: "630,000", sttAch: "265,168", performanceStatus: "Below 85%", ercTgt: "396", ercAch: "179", sfTbrTgt: "100", sfTbrAch: "1", premiumSkuGoal: "43", premiumSkuAch: "3" },
            { area: "DHAKA", territory: "DHAKA WEST", tm: "NOOR MD. HABIBULLAH", lead: "JAYANTA BANIK", dhCode: "B004", dhName: "M/S Hasan Brothers Corporation", dffCode: "BDS0000024", dffName: "Parvez", sttTgt: "580,000", sttAch: "245,800", performanceStatus: "Below 85%", ercTgt: "447", ercAch: "260", sfTbrTgt: "100", sfTbrAch: "4", premiumSkuGoal: "43", premiumSkuAch: "24" },
            { area: "DHAKA", territory: "DHAKA WEST", tm: "NOOR MD. HABIBULLAH", lead: "JAYANTA BANIK", dhCode: "B007", dhName: "M/S Hasan Brothers Corporation 2", dffCode: "BDS0000016", dffName: "Al Amin", sttTgt: "980,000", sttAch: "283,076", performanceStatus: "Below 85%", ercTgt: "313", ercAch: "224", sfTbrTgt: "100", sfTbrAch: "1", premiumSkuGoal: "44", premiumSkuAch: "6" },
            { area: "DHAKA", territory: "DHAKA WEST", tm: "NOOR MD. HABIBULLAH", lead: "JAYANTA BANIK", dhCode: "B007", dhName: "M/S Hasan Brothers Corporation 2", dffCode: "BDS0000017", dffName: "Hasib", sttTgt: "640,000", sttAch: "302,799", performanceStatus: "85-90%", ercTgt: "420", ercAch: "256", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "44", premiumSkuAch: "7" },
            { area: "DHAKA", territory: "DHAKA WEST", tm: "NOOR MD. HABIBULLAH", lead: "JAYANTA BANIK", dhCode: "B007", dhName: "M/S Hasan Brothers Corporation 2", dffCode: "BDS0000018", dffName: "Siam", sttTgt: "690,000", sttAch: "420,322", performanceStatus: "Above 90%", ercTgt: "445", ercAch: "266", sfTbrTgt: "100", sfTbrAch: "1", premiumSkuGoal: "44", premiumSkuAch: "14" },
            { area: "DHAKA", territory: "DHAKA WEST", tm: "NOOR MD. HABIBULLAH", lead: "JAYANTA BANIK", dhCode: "B007", dhName: "M/S Hasan Brothers Corporation 2", dffCode: "BDS0000019", dffName: "Rabbi", sttTgt: "600,000", sttAch: "301,639", performanceStatus: "Above 90%", ercTgt: "260", ercAch: "219", sfTbrTgt: "100", sfTbrAch: "1", premiumSkuGoal: "44", premiumSkuAch: "5" },
            { area: "DHAKA", territory: "DHAKA WEST", tm: "NOOR MD. HABIBULLAH", lead: "JAYANTA BANIK", dhCode: "B007", dhName: "M/S Hasan Brothers Corporation 2", dffCode: "BDS0000020", dffName: "Forhad", sttTgt: "650,000", sttAch: "310,908", performanceStatus: "85-90%", ercTgt: "318", ercAch: "221", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "44", premiumSkuAch: "9" },
            { area: "DHAKA", territory: "DHAKA NORTH MIRPUR", tm: "FARHAN MORSHED KHAN", lead: "JAYANTA BANIK", dhCode: "B006", dhName: "Paragon Marketing Limited", dffCode: "BDS0000054", dffName: "Nasim", sttTgt: "510,000", sttAch: "140,993", performanceStatus: "Below 85%", ercTgt: "376", ercAch: "90", sfTbrTgt: "100", sfTbrAch: "2", premiumSkuGoal: "44", premiumSkuAch: "5" },
            { area: "DHAKA", territory: "DHAKA NORTH MIRPUR", tm: "FARHAN MORSHED KHAN", lead: "JAYANTA BANIK", dhCode: "B006", dhName: "Paragon Marketing Limited", dffCode: "BDS0000055", dffName: "Asad", sttTgt: "1,050,000", sttAch: "408,921", performanceStatus: "Below 85%", ercTgt: "456", ercAch: "263", sfTbrTgt: "100", sfTbrAch: "3", premiumSkuGoal: "44", premiumSkuAch: "8" },
            { area: "DHAKA", territory: "DHAKA NORTH MIRPUR", tm: "FARHAN MORSHED KHAN", lead: "JAYANTA BANIK", dhCode: "B006", dhName: "Paragon Marketing Limited", dffCode: "BDS0000056", dffName: "Rony", sttTgt: "1,050,000", sttAch: "446,975", performanceStatus: "Below 85%", ercTgt: "475", ercAch: "131", sfTbrTgt: "100", sfTbrAch: "1", premiumSkuGoal: "45", premiumSkuAch: "9" },
            { area: "DHAKA", territory: "DHAKA NORTH MIRPUR", tm: "FARHAN MORSHED KHAN", lead: "JAYANTA BANIK", dhCode: "B006", dhName: "Paragon Marketing Limited", dffCode: "BDS0000057", dffName: "Toriqul", sttTgt: "800,000", sttAch: "169,074", performanceStatus: "Below 85%", ercTgt: "341", ercAch: "97", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "44", premiumSkuAch: "2" },
            { area: "DHAKA", territory: "DHAKA NORTH MIRPUR", tm: "FARHAN MORSHED KHAN", lead: "JAYANTA BANIK", dhCode: "B006", dhName: "Paragon Marketing Limited", dffCode: "BDS0000058", dffName: "Salim", sttTgt: "850,000", sttAch: "339,035", performanceStatus: "Below 85%", ercTgt: "352", ercAch: "176", sfTbrTgt: "100", sfTbrAch: "2", premiumSkuGoal: "44", premiumSkuAch: "3" },
            { area: "DHAKA", territory: "DHAKA NORTH MIRPUR", tm: "FARHAN MORSHED KHAN", lead: "JAYANTA BANIK", dhCode: "B006", dhName: "Paragon Marketing Limited", dffCode: "BDS0000059", dffName: "Tamim", sttTgt: "1,240,000", sttAch: "397,643", performanceStatus: "Below 85%", ercTgt: "350", ercAch: "191", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "45", premiumSkuAch: "5" },
            { area: "DHAKA", territory: "DHAKA NORTH MIRPUR", tm: "FARHAN MORSHED KHAN", lead: "JAYANTA BANIK", dhCode: "B006", dhName: "Paragon Marketing Limited", dffCode: "BDS0000060", dffName: "Limon", sttTgt: "850,000", sttAch: "156,467", performanceStatus: "Below 85%", ercTgt: "350", ercAch: "105", sfTbrTgt: "100", sfTbrAch: "4", premiumSkuGoal: "44", premiumSkuAch: "4" },
            { area: "DHAKA", territory: "DHAKA NORTH UTTARA", tm: "NURUL ALAM", lead: "JAYANTA BANIK", dhCode: "B008", dhName: "Self Tech Marketing Ltd", dffCode: "BDS0000061", dffName: "Fahim", sttTgt: "630,000", sttAch: "374,702", performanceStatus: "Above 90%", ercTgt: "320", ercAch: "278", sfTbrTgt: "100", sfTbrAch: "2", premiumSkuGoal: "44", premiumSkuAch: "34" },
            { area: "DHAKA", territory: "DHAKA NORTH UTTARA", tm: "NURUL ALAM", lead: "JAYANTA BANIK", dhCode: "B008", dhName: "Self Tech Marketing Ltd", dffCode: "BDS0000062", dffName: "Alif", sttTgt: "630,000", sttAch: "276,255", performanceStatus: "Below 85%", ercTgt: "381", ercAch: "283", sfTbrTgt: "100", sfTbrAch: "55", premiumSkuGoal: "44", premiumSkuAch: "28" },
            { area: "DHAKA", territory: "DHAKA NORTH UTTARA", tm: "NURUL ALAM", lead: "JAYANTA BANIK", dhCode: "B008", dhName: "Self Tech Marketing Ltd", dffCode: "BDS0000063", dffName: "Mahi", sttTgt: "830,000", sttAch: "436,293", performanceStatus: "Above 90%", ercTgt: "320", ercAch: "248", sfTbrTgt: "100", sfTbrAch: "5", premiumSkuGoal: "44", premiumSkuAch: "21" },
            { area: "DHAKA", territory: "DHAKA NORTH UTTARA", tm: "NURUL ALAM", lead: "JAYANTA BANIK", dhCode: "B008", dhName: "Self Tech Marketing Ltd", dffCode: "BDS0000064", dffName: "Akram", sttTgt: "810,000", sttAch: "493,099", performanceStatus: "Above 90%", ercTgt: "350", ercAch: "230", sfTbrTgt: "100", sfTbrAch: "6", premiumSkuGoal: "44", premiumSkuAch: "21" },
            { area: "DHAKA", territory: "DHAKA NORTH UTTARA", tm: "NURUL ALAM", lead: "JAYANTA BANIK", dhCode: "B008", dhName: "Self Tech Marketing Ltd", dffCode: "BDS0000065", dffName: "Krishno", sttTgt: "520,000", sttAch: "95,708", performanceStatus: "Below 85%", ercTgt: "329", ercAch: "114", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "44", premiumSkuAch: "0" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B014", dhName: "Unitrust Trading Co.", dffCode: "BDS0000070", dffName: "Mohidul islam", sttTgt: "730,000", sttAch: "256,791", performanceStatus: "Below 85%", ercTgt: "358", ercAch: "242", sfTbrTgt: "100", sfTbrAch: "3", premiumSkuGoal: "45", premiumSkuAch: "23" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B014", dhName: "Unitrust Trading Co.", dffCode: "BDS0000071", dffName: "Abul Kalam", sttTgt: "776,000", sttAch: "221,778", performanceStatus: "Below 85%", ercTgt: "388", ercAch: "219", sfTbrTgt: "100", sfTbrAch: "2", premiumSkuGoal: "40", premiumSkuAch: "15" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B014", dhName: "Unitrust Trading Co.", dffCode: "BDS0000072", dffName: "MD. Shahed Mia", sttTgt: "817,000", sttAch: "284,656", performanceStatus: "Below 85%", ercTgt: "383", ercAch: "233", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "41", premiumSkuAch: "16" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B014", dhName: "Unitrust Trading Co.", dffCode: "BDS0000073", dffName: "Saiful Islam Siam", sttTgt: "723,000", sttAch: "359,888", performanceStatus: "Above 90%", ercTgt: "408", ercAch: "321", sfTbrTgt: "100", sfTbrAch: "10", premiumSkuGoal: "44", premiumSkuAch: "6" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B014", dhName: "Unitrust Trading Co.", dffCode: "BDS0000074", dffName: "MD. Iqbal Khan", sttTgt: "868,000", sttAch: "308,713", performanceStatus: "Below 85%", ercTgt: "271", ercAch: "215", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "35", premiumSkuAch: "19" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B014", dhName: "Unitrust Trading Co.", dffCode: "BDS0000075", dffName: "MD. Forhad Hasan", sttTgt: "873,000", sttAch: "317,772", performanceStatus: "Below 85%", ercTgt: "292", ercAch: "206", sfTbrTgt: "100", sfTbrAch: "4", premiumSkuGoal: "55", premiumSkuAch: "19" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B002", dhName: "Takwa Enterprise", dffCode: "BDS0000006", dffName: "Parvez Rifayaz", sttTgt: "1,085,000", sttAch: "414,412", performanceStatus: "Below 85%", ercTgt: "369", ercAch: "240", sfTbrTgt: "100", sfTbrAch: "6", premiumSkuGoal: "69", premiumSkuAch: "36" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B002", dhName: "Takwa Enterprise", dffCode: "BDS0000007", dffName: "Sobuj Hossain", sttTgt: "723,000", sttAch: "369,011", performanceStatus: "Above 90%", ercTgt: "408", ercAch: "297", sfTbrTgt: "100", sfTbrAch: "1", premiumSkuGoal: "60", premiumSkuAch: "5" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B002", dhName: "Takwa Enterprise", dffCode: "BDS0000008", dffName: "Borhan Uddin", sttTgt: "922,000", sttAch: "512,462", performanceStatus: "Above 90%", ercTgt: "353", ercAch: "228", sfTbrTgt: "100", sfTbrAch: "5", premiumSkuGoal: "85", premiumSkuAch: "64" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B002", dhName: "Takwa Enterprise", dffCode: "BDS0000009", dffName: "Saiful Islam Rohan", sttTgt: "649,000", sttAch: "319,312", performanceStatus: "Above 90%", ercTgt: "429", ercAch: "307", sfTbrTgt: "100", sfTbrAch: "3", premiumSkuGoal: "50", premiumSkuAch: "12" },
            { area: "DHAKA", territory: "DHAKA EAST", tm: "MESBA RAHMAN", lead: "JAYANTA BANIK", dhCode: "B002", dhName: "Takwa Enterprise", dffCode: "BDS0000010", dffName: "Zahangir Alom", sttTgt: "1,030,000", sttAch: "454,527", performanceStatus: "Below 85%", ercTgt: "341", ercAch: "282", sfTbrTgt: "100", sfTbrAch: "11", premiumSkuGoal: "66", premiumSkuAch: "8" },
            { area: "DHAKA", territory: "DHAKA SOUTH", tm: "RAYHAN MASUD", lead: "JAYANTA BANIK", dhCode: "B003", dhName: "M/S Sanuar Enterprise", dffCode: "BDS0000011", dffName: "Hasib", sttTgt: "888,000", sttAch: "298,391", performanceStatus: "Below 85%", ercTgt: "394", ercAch: "142", sfTbrTgt: "100", sfTbrAch: "4", premiumSkuGoal: "44", premiumSkuAch: "8" },
            { area: "DHAKA", territory: "DHAKA SOUTH", tm: "RAYHAN MASUD", lead: "JAYANTA BANIK", dhCode: "B003", dhName: "M/S Sanuar Enterprise", dffCode: "BDS0000012", dffName: "Sajid", sttTgt: "655,000", sttAch: "290,886", performanceStatus: "Below 85%", ercTgt: "382", ercAch: "183", sfTbrTgt: "100", sfTbrAch: "4", premiumSkuGoal: "44", premiumSkuAch: "12" },
            { area: "DHAKA", territory: "DHAKA SOUTH", tm: "RAYHAN MASUD", lead: "JAYANTA BANIK", dhCode: "B003", dhName: "M/S Sanuar Enterprise", dffCode: "BDS0000013", dffName: "Shawon", sttTgt: "645,000", sttAch: "248,770", performanceStatus: "Below 85%", ercTgt: "382", ercAch: "229", sfTbrTgt: "100", sfTbrAch: "5", premiumSkuGoal: "44", premiumSkuAch: "23" },
            { area: "DHAKA", territory: "DHAKA SOUTH", tm: "RAYHAN MASUD", lead: "JAYANTA BANIK", dhCode: "B003", dhName: "M/S Sanuar Enterprise", dffCode: "BDS0000014", dffName: "Sunny", sttTgt: "634,000", sttAch: "225,691", performanceStatus: "Below 85%", ercTgt: "360", ercAch: "151", sfTbrTgt: "100", sfTbrAch: "4", premiumSkuGoal: "44", premiumSkuAch: "0" },
            { area: "DHAKA", territory: "DHAKA SOUTH", tm: "RAYHAN MASUD", lead: "JAYANTA BANIK", dhCode: "B003", dhName: "M/S Sanuar Enterprise", dffCode: "BDS0000015", dffName: "Alamin", sttTgt: "581,000", sttAch: "216,465", performanceStatus: "Below 85%", ercTgt: "381", ercAch: "125", sfTbrTgt: "100", sfTbrAch: "4", premiumSkuGoal: "44", premiumSkuAch: "5" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B001", dhName: "Karim Trading", dffCode: "", dffName: "Niloy Sarker", sttTgt: "450,000", sttAch: "0", performanceStatus: "Below 85%", ercTgt: "320", ercAch: "0", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "40", premiumSkuAch: "0" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B001", dhName: "Karim Trading", dffCode: "", dffName: "Mahedi Alam", sttTgt: "450,000", sttAch: "0", performanceStatus: "Below 85%", ercTgt: "381", ercAch: "0", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "40", premiumSkuAch: "0" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B001", dhName: "Karim Trading", dffCode: "", dffName: "Probal Mollick", sttTgt: "650,000", sttAch: "0", performanceStatus: "Below 85%", ercTgt: "320", ercAch: "0", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "40", premiumSkuAch: "0" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B001", dhName: "Karim Trading", dffCode: "", dffName: "Ismail Hossain", sttTgt: "500,000", sttAch: "0", performanceStatus: "Below 85%", ercTgt: "350", ercAch: "0", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "40", premiumSkuAch: "0" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B001", dhName: "Karim Trading", dffCode: "", dffName: "Ratul Das", sttTgt: "450,000", sttAch: "0", performanceStatus: "Below 85%", ercTgt: "329", ercAch: "0", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "40", premiumSkuAch: "0" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B010", dhName: "M/S Farid Enterprise", dffCode: "BDS0000045", dffName: "Arafat Hossain Musa", sttTgt: "580,000", sttAch: "167,078", performanceStatus: "Below 85%", ercTgt: "360", ercAch: "227", sfTbrTgt: "100", sfTbrAch: "3", premiumSkuGoal: "50", premiumSkuAch: "11" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B010", dhName: "M/S Farid Enterprise", dffCode: "BDS0000046", dffName: "Tanvir Ahmed", sttTgt: "420,000", sttAch: "43,420", performanceStatus: "Below 85%", ercTgt: "364", ercAch: "82", sfTbrTgt: "100", sfTbrAch: "2", premiumSkuGoal: "30", premiumSkuAch: "0" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B010", dhName: "M/S Farid Enterprise", dffCode: "BDS0000047", dffName: "Shakkhor Majumdar", sttTgt: "430,000", sttAch: "157,857", performanceStatus: "Below 85%", ercTgt: "313", ercAch: "219", sfTbrTgt: "100", sfTbrAch: "1", premiumSkuGoal: "30", premiumSkuAch: "0" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B009", dhName: "ARC Trading", dffCode: "BDS0000038", dffName: "Tipu Das", sttTgt: "640,000", sttAch: "299,561", performanceStatus: "85-90%", ercTgt: "507", ercAch: "304", sfTbrTgt: "100", sfTbrAch: "12", premiumSkuGoal: "55", premiumSkuAch: "4" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B009", dhName: "ARC Trading", dffCode: "BDS0000039", dffName: "MD Abdul Malek", sttTgt: "1,600,000", sttAch: "559,801", performanceStatus: "Below 85%", ercTgt: "320", ercAch: "122", sfTbrTgt: "100", sfTbrAch: "0", premiumSkuGoal: "25", premiumSkuAch: "0" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B009", dhName: "ARC Trading", dffCode: "BDS0000040", dffName: "Aiyas Ibne Abedin", sttTgt: "573,000", sttAch: "246,617", performanceStatus: "Below 85%", ercTgt: "473", ercAch: "292", sfTbrTgt: "100", sfTbrAch: "4", premiumSkuGoal: "55", premiumSkuAch: "10" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B012", dhName: "P M Traders", dffCode: "BDS0000066", dffName: "Md Arshad", sttTgt: "540,000", sttAch: "254,836", performanceStatus: "85-90%", ercTgt: "329", ercAch: "269", sfTbrTgt: "100", sfTbrAch: "13", premiumSkuGoal: "30", premiumSkuAch: "13" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B012", dhName: "P M Traders", dffCode: "BDS0000067", dffName: "Md Forhad", sttTgt: "460,000", sttAch: "224,770", performanceStatus: "Above 90%", ercTgt: "361", ercAch: "315", sfTbrTgt: "100", sfTbrAch: "2", premiumSkuGoal: "30", premiumSkuAch: "7" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B013", dhName: "Madina Traders", dffCode: "BDS0000068", dffName: "Md Shojibul Islam", sttTgt: "460,000", sttAch: "254,188", performanceStatus: "Above 90%", ercTgt: "299", ercAch: "201", sfTbrTgt: "100", sfTbrAch: "3", premiumSkuGoal: "30", premiumSkuAch: "8" },
            { area: "CTG", territory: "CTG NORTH & SOUTH", tm: "MONIRUZZAMAN MONIR", lead: "SHAJED KIBRIA", dhCode: "B013", dhName: "Madina Traders", dffCode: "BDS0000069", dffName: "Md Ariful Islam", sttTgt: "540,000", sttAch: "243,219", performanceStatus: "Below 85%", ercTgt: "302", ercAch: "223", sfTbrTgt: "100", sfTbrAch: "1", premiumSkuGoal: "30", premiumSkuAch: "25" }
        ];


        // We parse the data to ensure all values are numeric
        // (FIXED) fullSrData is now defined *after* rawSrData
        const fullSrData = rawSrData.map(sr => {
            // Parse all numeric fields
            sr.sttTgt = parseNumeric(sr.sttTgt);
            sr.sttAch = parseNumeric(sr.sttAch);
            sr.ercTgt = parseNumeric(sr.ercTgt);
            sr.ercAch = parseNumeric(sr.ercAch);
            sr.sfTbrTgt = parseNumeric(sr.sfTbrTgt);
            sr.sfTbrAch = parseNumeric(sr.sfTbrAch);
            sr.premiumSkuGoal = parseNumeric(sr.premiumSkuGoal);
            sr.premiumSkuAch = parseNumeric(sr.premiumSkuAch);
            // performanceStatus is already a string, no parsing needed
            return sr;
        });


        function preProcessData() {
            // 1. Calculate percentages for all detailed SR data
            fullSrData.forEach(item => calculatePercentages(item));
            
            // 2. Aggregate SR data up to the Territory level
            const territoryMap = new Map();
            fullSrData.forEach(sr => {
                const key = sr.territory;
                if (!territoryMap.has(key)) {
                    territoryMap.set(key, {
                        territory: sr.territory,
                        tm: sr.tm,
                        area: sr.area,
                        dhName: sr.dhName, // Note: this will take the DHName of the *first* SR in that territory
                        sttTgt: 0, sttAch: 0, ercTgt: 0, ercAch: 0,
                        sfTbrTgt: 0, sfTbrAch: 0, premiumSkuGoal: 0, premiumSkuAch: 0
                    });
                }
                const territory = territoryMap.get(key);
                territory.sttTgt += sr.sttTgt;
                territory.sttAch += sr.sttAch;
                territory.ercTgt += sr.ercTgt;
                territory.ercAch += sr.ercAch;
                territory.sfTbrTgt += sr.sfTbrTgt;
                territory.sfTbrAch += sr.sfTbrAch;
                territory.premiumSkuGoal += sr.premiumSkuGoal;
                territory.premiumSkuAch += sr.premiumSkuAch;
            });
            
            // 3. Aggregate SR data up to the DB level
            const dbMap = new Map();
            fullSrData.forEach(sr => {
                const key = sr.dhName;
                if (!dbMap.has(key)) {
                    dbMap.set(key, {
                        dhName: sr.dhName,
                        area: sr.area,
                        territory: sr.territory, // Note: this will take the territory of the *first* SR for that DB
                        sttTgt: 0, sttAch: 0, ercTgt: 0, ercAch: 0,
                        sfTbrTgt: 0, sfTbrAch: 0, premiumSkuGoal: 0, premiumSkuAch: 0
                    });
                }
                const db = dbMap.get(key);
                db.sttTgt += sr.sttTgt;
                db.sttAch += sr.sttAch;
                db.ercTgt += sr.ercTgt;
                db.ercAch += sr.ercAch;
                db.sfTbrTgt += sr.sfTbrTgt;
                db.sfTbrAch += sr.sfTbrAch;
                db.premiumSkuGoal += sr.premiumSkuGoal;
                db.premiumSkuAch += sr.premiumSkuAch;
            });

            // Overwrite the global arrays with the new aggregated data
            processedTerritoryData = Array.from(territoryMap.values());
            processedDbData = Array.from(dbMap.values());
            
            // Re-calculate percentages for the new aggregated data
            processedTerritoryData.forEach(item => calculatePercentages(item));
            processedDbData.forEach(item => calculatePercentages(item));

            // (NEW) Assign national rank to all SRs
            const nationallySortedSrs = [...fullSrData].sort((a, b) => b.sttAchPercent - a.sttAchPercent);
            nationallySortedSrs.forEach((sr, index) => {
                sr.nationalRank = index + 1;
            });
        }

        
        /**
         * (FIXED) This function was broken and incomplete.
         * Restored to full functionality.
         */
        function applyFilters() {
            let filteredTerritories = [...processedTerritoryData];
            let filteredDbs = [...processedDbData];
            let filteredSrs = [...fullSrData];

            // 1. Filter by Area
            if (selectedFilters.Area !== 'All Areas') {
                filteredTerritories = filteredTerritories.filter(data => data.area === selectedFilters.Area);
                filteredDbs = filteredDbs.filter(data => data.area === selectedFilters.Area);
                filteredSrs = filteredSrs.filter(data => data.area === selectedFilters.Area);
            }

            // 2. Filter by Territory
            if (selectedFilters.Territory !== 'All Territories') {
                filteredTerritories = filteredTerritories.filter(data => data.territory === selectedFilters.Territory);
                filteredDbs = filteredDbs.filter(data => data.territory === selectedFilters.Territory);
                filteredSrs = filteredSrs.filter(data => data.territory === selectedFilters.Territory);
            }

            // 3. Filter by DB Name (dhName key)
            if (selectedFilters['DB Name'] !== 'All DBs') {
                // (FIXED) Filter territories based on SR data, not first SR's DH name
                const matchingTerritories = new Set(filteredSrs.filter(sr => sr.dhName === selectedFilters['DB Name']).map(sr => sr.territory));
                filteredTerritories = filteredTerritories.filter(t => matchingTerritories.has(t.territory));
                
                filteredDbs = filteredDbs.filter(data => data.dhName === selectedFilters['DB Name']);
                filteredSrs = filteredSrs.filter(data => data.dhName === selectedFilters['DB Name']);
            }

            // Determine which data to use for KPI calculation
            // (FIXED) Prioritize the most specific filter for KPI totals, regardless of tab.
            let dataForKpiTotals;
            
            if (selectedFilters['DB Name'] !== 'All DBs') {
                // Most specific filter: a single DB is selected.
                // Use the filtered DB data for totals, even if on Territory tab.
                dataForKpiTotals = filteredDbs; 
            } else if (selectedFilters.Territory !== 'All Territories') {
                // Next specific: a Territory is selected.
                // Use the filtered Territory data.
                dataForKpiTotals = filteredTerritories;
            } else if (selectedFilters.Area !== 'All Areas') {
                // Next specific: an Area is selected.
                // Use the filtered Territory data (which is already filtered by Area).
                dataForKpiTotals = filteredTerritories;
            } else {
                // No filters are active. Use the full SR data for a true grand total.
                dataForKpiTotals = fullSrData;
            }


            // 4. Recalculate KPIs based on filtered data
            const totals = calculateGrandTotals(dataForKpiTotals);
            const newKpiData = updateKpiData(totals);

            // 5. Re-render all components
            populateKpiCards(newKpiData);
            populateTable('territory-list', filteredTerritories, 'territory', 'tm');
            populateTable('db-list', filteredDbs, 'dhName', 'territory');
            populateTable('sr-list', filteredSrs, 'dffName', 'dhName', true); // true = SR table
            
            populateTerritoryChart(filteredTerritories);
            populateDbChart(filteredDbs);
            populateTopBottomSrCharts(filteredSrs);
            
            updateSrStatus(filteredSrs); // <-- ADDED
            updateDbStatus(filteredDbs); // <-- RESTORED
        }

        
        /**
         * (REWRITTEN) This function now uses the new helper functions
         * to create dynamic, dependent dropdowns.
         */
        function initializeFilters() {
            const filterControls = document.getElementById('filter-controls');
            filterControls.innerHTML = '';
            
            // (Data for filters is now derived from the fullSrData array to ensure accuracy)
            const areas = [...new Set(fullSrData.map(item => item.area))];
            const territories = [...new Set(fullSrData.map(item => item.territory))];
            const dbNames = [...new Set(fullSrData.map(item => item.dhName))];
            
            const dynamicFilterOptions = {
                'Area': ['All Areas', ...areas.sort()],
                'Territory': ['All Territories', ...territories.sort()],
                'DB Name': ['All DBs', ...dbNames.sort()]
            };

            // Create dropdowns and store references
            const areaDropdown = createFilterDropdown('Area', dynamicFilterOptions['Area']);
            areaSelect = areaDropdown.select;
            
            const territoryDropdown = createFilterDropdown('Territory', dynamicFilterOptions['Territory']);
            territorySelect = territoryDropdown.select;

            const dbNameDropdown = createFilterDropdown('DB Name', dynamicFilterOptions['DB Name']);
            dbNameSelect = dbNameDropdown.select;

            // Append to DOM
            filterControls.appendChild(areaDropdown.wrapper);
            filterControls.appendChild(territoryDropdown.wrapper);
            filterControls.appendChild(dbNameDropdown.wrapper);
        }
        
        function initializeTabs() {
            const tabTerritory = document.getElementById('tab-territory');
            const tabDb = document.getElementById('tab-db');
            const tabSr = document.getElementById('tab-sr');
            
            const panelTerritory = document.getElementById('panel-territory');
            const panelDb = document.getElementById('panel-db');
            const panelSr = document.getElementById('panel-sr');
            
            const visualsMain = document.getElementById('visuals-panel-main');
            const visualsSr = document.getElementById('visuals-panel-sr');
            
            const chartTerritory = document.getElementById('territory-chart-container');
            const chartDb = document.getElementById('db-chart-container');
            
            tabTerritory.addEventListener('click', () => {
                activeTab = 'territory';
                // Buttons
                tabTerritory.classList.add('tab-active');
                tabTerritory.classList.remove('tab-inactive');
                tabDb.classList.add('tab-inactive');
                tabDb.classList.remove('tab-active');
                tabSr.classList.add('tab-inactive');
                tabSr.classList.remove('tab-active');
                // Panels
                panelTerritory.style.display = 'block';
                panelDb.style.display = 'none';
                panelSr.style.display = 'none';
                // Visuals
                visualsMain.style.display = 'grid';
                visualsSr.style.display = 'none';
                chartTerritory.style.display = 'block';
                chartDb.style.display = 'none';
                // Re-apply filters to update KPIs if needed
                applyFilters();
            });
            
            tabDb.addEventListener('click', () => {
                activeTab = 'db';
                // Buttons
                tabTerritory.classList.remove('tab-active');
                tabTerritory.classList.add('tab-inactive');
                tabDb.classList.remove('tab-inactive');
                tabDb.classList.add('tab-active');
                tabSr.classList.add('tab-inactive');
                tabSr.classList.remove('tab-active');
                // Panels
                panelTerritory.style.display = 'none';
                panelDb.style.display = 'block';
                panelSr.style.display = 'none';
                // Visuals
                visualsMain.style.display = 'grid';
                visualsSr.style.display = 'none';
                chartTerritory.style.display = 'none';
                chartDb.style.display = 'block';
                // Re-apply filters to update KPIs
                applyFilters();
            });
            
            tabSr.addEventListener('click', () => {
                activeTab = 'sr';
                // Buttons
                tabTerritory.classList.remove('tab-active');
                tabTerritory.classList.add('tab-inactive');
                tabDb.classList.remove('tab-active');
                tabDb.classList.add('tab-inactive');
                tabSr.classList.remove('tab-inactive');
                tabSr.classList.add('tab-active');
                // Panels
                panelTerritory.style.display = 'none';
                panelDb.style.display = 'none';
                panelSr.style.display = 'block';
                // Visuals
                visualsMain.style.display = 'none';
                visualsSr.style.display = 'grid';
                // No need to toggle territory/db charts as they are in the other panel
                // Re-apply filters to update KPIs
                applyFilters();
            });
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Process all data first (Calculate percentages, aggregate)
            preProcessData(); // This will create the aggregated 'processedTerritoryData' and 'processedDbData'

            // 2. Calculate initial KPIs based on the *full SR data* for accuracy
            const initialTotals = calculateGrandTotals(fullSrData);
            const initialKpiData = updateKpiData(initialTotals);

            // 3. Render all components using the correct data
            populateKpiCards(initialKpiData);
            populateTable('territory-list', processedTerritoryData, 'territory', 'tm'); // Use aggregated data
            populateTable('db-list', processedDbData, 'dhName', 'territory'); // Use aggregated data
            populateTable('sr-list', fullSrData, 'dffName', 'dhName', true); // true = SR table
            
            populateTerritoryChart(processedTerritoryData); // Use aggregated data
            populateDbChart(processedDbData); // Use aggregated data
            populateTopBottomSrCharts(fullSrData);
            
            updateSrStatus(fullSrData); // <-- ADDED
            updateDbStatus(processedDbData); // <-- RESTORED
            initializeFilters(); 
            initializeTabs();
        });
    </script>
</body>
</html>
